---
title: "Reviewing ANOVA conventions in published articles"
author: "[Haiyang Jin](https://haiyangjin.github.io/) and Yuzhu Ji"
date: "`r format(Sys.Date(), '%Y-%b-%d')`"
output: 
  html_document:
    code_folding: hide
    number_sections: true
    toc: true
    toc_depth: 4
    toc_float: true
    df_print: paged
---

<style>
pre {
  overflow-x: auto;
}
pre code {
  word-wrap: normal;
  white-space: pre;
}
</style>

# Preparations

```{r setup, include=FALSE}
## load libraries
library(tidyverse)
library(vcd)
library(ggpubr)
library(RColorBrewer)

theme_set(papaja::theme_apa())

# set global chunk options, put figures into folder
knitr::opts_chunk$set(
  echo = TRUE, warning = FALSE, message = FALSE, 
  include = TRUE, tidy = FALSE, archive = FALSE,
  size = "big", fig.width=8, fig.asp=0.7, 
  width = 1800,
  emmeans=list(msg.interaction=FALSE))

source(here::here("R", "funcs.R"))
source(here::here("R", "func_kappa.R"))
set.seed(2022)
```

```{r}
two_colors <- c("#D55E00", "#56B4E9")
custom_clr <- c("#7F7F7F", "#E64B35", "#56B4E9", "#DF8F44", "#008B45", "#925E9F", "#415384", "#000000")
```


## Read data

```{r}
# article ID and journal
df_publ <- readxl::read_excel(here::here("data", "CodingSheet_anova.xlsx"),
                              sheet="PaperMeta",
                              range="A1:G750") %>%
  transmute(`Paper ID`, journal = `Publication Title`) %>% 
  mutate(journal = factor(journal),
         journal = fct_recode(journal,
                              JEPG="Journal of Experimental Psychology: General",
                              `Psych Sci`="Psychological Science",
                              `J Abn Psych`="Journal of Abnormal Psychology",
                              JCCP="Journal of Consulting and Clinical Psychology",
                              JESP="Journal of Experimental Social Psychology",
                              JPSP="Journal of Personality and Social Psychology"),
         journal = fct_relevel(journal, "JEPG", "Psych Sci", "J Abn Psych", "JCCP", "JESP", "JPSP")) 

# "Title_Prescreening" Sheet
df_prescreen <- readxl::read_excel(here::here("data", "CodingSheet_anova.xlsx"),
                                   sheet="Title_Prescreening",
                                   range="A1:C750") %>%
  left_join(df_publ, by="Paper ID") %>%
  select(-Title)

# "ResearchPaper" Sheet
df_mainscreen <- readxl::read_excel(here::here("data", "CodingSheet_anova.xlsx"),
                               sheet="ResearchPaper",
                               range="A1:L750") %>%
  left_join(df_publ, by="Paper ID") %>%
  select(-Title)
```

```{r}
# read the coding sheet for the first round by YJ
# df_conv_YJ1 <- readxl::read_excel(here::here("data", "CodingSheet_pilot.xlsx"), 
#                                  sheet="AnalysisInfo_YJ",
#                                  range="A1:AO39") %>% 
#   select(-Title) 
# 
# # read the coding sheet for the first round by HJ
# df_conv_HJ1 <- readxl::read_excel(here::here("data", "CodingSheet_pilot.xlsx"), 
#                                  sheet="AnalysisInfo_HJ",
#                                  range="A1:AO39") %>% 
#   select(-Title) 
```


```{r}
# # read the coding sheet for the first round (after resolving inconsistency)
# df_conv_1 <- readxl::read_excel(here::here("data", "CodingSheet_pilot.xlsx"), 
#                                  sheet="AnalysisInfo_1st",
#                                  range="A1:AO39") %>% 
#   select(-Title) 
# # read the coding sheet for the second round by YJ
# df_conv_YJ2 <- readxl::read_excel(here::here("data", "CodingSheet_pilot.xlsx"), 
#                                  sheet="AnalysisInfo_2nd_YJ",
#                                  range="A1:AO39") %>% 
#   select(-Title) 
# # read the coding sheet for the second round by YJ
# df_conv_HJ2 <- readxl::read_excel(here::here("data", "CodingSheet_pilot.xlsx"), 
#                                  sheet="AnalysisInfo_2nd_YJ",
#                                  range="A1:AO39") %>% 
#   select(-Title) 
# 
# df_conv <- bind_rows(df_conv_1, df_conv_YJ2, df_conv_HJ2) %>% 
#   left_join(df_publ, by="Paper ID")

# df_conv <- readxl::read_excel(here::here("data", "CodingSheet_pilot.xlsx"), 
#                                  sheet="AnalysisInfo_HJ",
#                                  range="A1:AO39") %>% 
#   left_join(df_publ, by="Paper ID") %>% 
#   select(-Title) 
```


# Intra-rater consistency
Estimate the intra-rater consistency for the information on whether the study employed ANOVA, experimental designs and the ANOVA prevalence inspected by Y.J. and H.J. separately.

## Research article and ANOVA

```{r}
# # whether it is a research article (unweighted)
df_res_K <- df_mainscreen %>%
  select(`Research article_YJ`, `Research article_HJ`) %>%
  group_by(`Research article_YJ`, `Research article_HJ`) %>%
  summarize(count = n(), .groups = "drop") %>%
  pivot_wider(names_from=`Research article_HJ`, values_from = count, values_fill = 0)

Ka_res <- df_res_K %>%
  select(-`Research article_YJ`) %>%
  as.matrix() %>%
  Kappa()

print(Ka_res, CI=TRUE) # Kappa for research articles
```

```{r}
# whether ANOVA was used (unweighted)
df_aov_K <- df_mainscreen %>% 
  filter(`Research article`==1) %>% # only among research articles
  select(`Use ANOVA_YJ`, `Use ANOVA_HJ`) %>% 
  group_by(`Use ANOVA_YJ`, `Use ANOVA_HJ`) %>% 
  summarize(count=n(), .groups="drop") %>% 
  pivot_wider(names_from=`Use ANOVA_HJ`, values_from = count, values_fill = 0) 

Ka_aov <- df_aov_K %>% 
  select(-`Use ANOVA_YJ`) %>% 
  as.matrix() %>% 
  Kappa()

print(Ka_aov, CI=TRUE) # Kappa for using ANOVA
```


## The first 120 articles

```{r}
# experimental designs
# design_list <- c("N_factor", "max_No_levels")
# 
# kappa_0 <- lapply(design_list, thekappa, df1=df_conv_YJ1, df2=df_conv_HJ1, isweighted=TRUE) %>% 
#   bind_rows()
```

```{r}
# Convention A
# con_a_list <- c("a1_report_all", "a3_correction")
# 
# kappa_a <- lapply(con_a_list, thekappa, 
#                   df1=filter(df_conv_YJ1, a2_multiway==1), 
#                   df2=filter(df_conv_HJ1, a2_multiway==1)) %>% 
#   bind_rows()
```

```{r}
# Convention B
# con_b_wlist <- c("b1_N_factor3+", "b2_N_significant_b1")
# con_b_ulist <- c("b7_posthoc", "b8_correction")
# 
# kappa_bw <- lapply(con_b_wlist, thekappa, isweighted=TRUE,
#                    df1=filter(df_conv_YJ1, max_No_levels>2), 
#                    df2=filter(df_conv_HJ1, max_No_levels>2)) %>% 
#   bind_rows()
# 
# kappa_bu <- lapply(con_b_ulist, thekappa, 
#                    df1=filter(df_conv_YJ1, max_No_levels>2), 
#                    df2=filter(df_conv_HJ1, max_No_levels>2)) %>% 
#   bind_rows()
# kappa_b <- bind_rows(kappa_bw, kappa_bu)
```

```{r}
# Convention C
# con_c_wlist <- c("c1_N_2way_inter", "c2_N_sig_in_c1")
# con_c_ulist <- c("c7_simple_effect", "c8_correction")
# 
# kappa_cw <- lapply(con_c_wlist, thekappa, isweighted=TRUE,
#                    df1=filter(df_conv_YJ1, N_factor>1), 
#                    df2=filter(df_conv_HJ1, N_factor>1)) %>% 
#   bind_rows()
# 
# kappa_cu <- lapply(con_c_ulist, thekappa, 
#                    df1=filter(df_conv_YJ1, N_factor>1), 
#                    df2=filter(df_conv_HJ1, N_factor>1)) %>% 
#   bind_rows()
# kappa_c <- bind_rows(kappa_cw, kappa_cu)
```

```{r}
# Convention D & E
# kappa_d1e1 <- thekappa(df1=filter(df_conv_YJ1, N_factor>2), 
#                     df2=filter(df_conv_HJ1, N_factor>2),
#                     colname="d1_e1_highest_sig")
# # kappa_d <- thekappa(df1=filter(df_conv_YJ1, N_factor>2, d1_e1_highest_sig==1), 
# #                     df2=filter(df_conv_HJ1, N_factor>2, d1_e1_highest_sig==1),
# #                     colname="d1_separate")
# kappa_e <- thekappa(df1=filter(df_conv_YJ1, N_factor>2, d1_e1_highest_sig==0), 
#                     df2=filter(df_conv_HJ1, N_factor>2, d1_e1_highest_sig==0),
#                     colname="e1_combine")
# 
# # kappa_de <- bind_rows(kappa_d1e1, kappa_d, kappa_e)
# kappa_de <- bind_rows(kappa_d1e1, kappa_e)
```

```{r}
# (kappa_df <- bind_rows(kappa_0, kappa_a, kappa_b, kappa_c, kappa_de))
```

```{r}
# the mean consistency
# tibble(mean = mean(kappa_df$value),
#        min = min(kappa_df$value),
#        max = max(kappa_df$value)) 
```

# ANOVA prevalence

## Screening information

```{r}
# number of articles included at each stage
df_included_all <- df_mainscreen %>%  
  summarize(journal = "Overall",
            In1_all = n(),
            In2_title = sum(1-Title_Prescreening),
            In3_research = sum(`Research article`),
            In4_ANOVA = sum(`Use ANOVA`),
            In5_include = sum(Included))

# number of articles at different stages
df_included <- df_mainscreen %>% 
  group_by(journal) %>% 
  summarize(In1_all = n(),
            In2_title = sum(1-Title_Prescreening),
            In3_research = sum(`Research article`),
            In4_ANOVA = sum(`Use ANOVA`),
            In5_include = sum(Included)) %>% 
  add_row(df_included_all, .before=1)
df_included
```

```{r}
# Percentage (relative to the total number of articles)
df_included %>% 
  transmute(journal, In1_all,
            In2_title = paste0(round((In2_title/In1_all)*100, 2), '%'),
            In3_research = paste0(round((In3_research/In1_all)*100, 2), '%'),
            In4_ANOVA = paste0(round((In4_ANOVA/In1_all)*100, 2), '%'),
            In5_include = paste0(round((In5_include/In1_all)*100, 2), '%'))
```


```{r}
# number of articles excluded at different stages
df_excluded <- df_mainscreen %>% 
  group_by(journal) %>% 
  summarize(Ex1_all = n(),
            Ex2_title = sum(Title_Prescreening),
            Ex3_research = sum(1-`Research article`),
            Ex4_ANOVA = sum(1-`Use ANOVA`),
            Ex5_exclude = sum(1-Included)) %>% 
  add_row( # add summary row
    summarize(df_mainscreen, 
              journal = "Overall",
              Ex1_all = n(),
              Ex2_title = sum(Title_Prescreening),
              Ex3_research = sum(1-`Research article`),
              Ex4_ANOVA = sum(1-`Use ANOVA`),
              Ex5_exclude = sum(1-Included)),
    .before=1)
df_excluded
```

## ANOVA prevalence
```{r}
# The percentage of articles employing ANOVA among all research articles:  
df_included %>% 
  mutate(prevalence_anova = round(In4_ANOVA/In3_research*100, 2))
```

## ANOVA complexity

```{r}
# df_complex <- df_conv %>% 
#   filter(included==1) %>% 
#   transmute(`Paper ID`, N_factor, max_No_levels, Design,
#             Design_int = str_split(Design, "_"),
#             Avg_No_levels = sapply(Design_int, function(x){mean(as.numeric(x))}),
#             Complexity = sapply(Design_int, function(x){prod(as.numeric(x))}),
#             journal)
```

Across ANOVAs:
```{r}
# df_complex %>% 
#   group_by(journal) %>% 
#   summarize(mean_N_factor = mean(N_factor),
#             mean_max_N_levels = mean(max_No_levels),
#             mean_complexity = mean(Complexity)) %>% 
#   add_row( # add summary row
#     summarize(df_complex, 
#               journal = "All",
#               mean_N_factor = mean(N_factor),
#               mean_max_N_levels = mean(max_No_levels),
#               mean_complexity = mean(Complexity))) 
```

```{r}
# plot_design <- df_complex %>% 
#   mutate(design_ = str_replace_all(Design, '_', '*')) %>% 
#   ggplot(aes(x = reorder(design_, Complexity))) +
#   geom_histogram(stat="count") +
#   labs(x = "Experimental designs")
# plot_design
```

alluvial figure (?) [left side is the experimental designs and the right side is the numbers of conditions.]
```{r}
# df_complex %>% 
#   select(Design, Complexity) %>% 
#   group_by(Design, Complexity) %>% 
#   summarize(count = n(), .groups="drop") 
```

## ANOVA convention prevalence

### Convention A: inspect all effects
```{r}
# df_conv_a <- df_conv %>% 
#   filter(a2_multiway==1) %>% 
#   select(`Paper ID`, starts_with("a"), journal)
# 
# # percentage of ANOVAs reporting/inspecting all effects among multi-way ANOVA
# df_conv_a_all <- summarize(df_conv_a, 
#                            journal = "All",
#                            conA = mean(a1_report_all))
# 
# df_conv_a %>% 
#   group_by(journal) %>% 
#   summarize(conA = mean(a1_report_all)) %>% 
#   add_row(df_conv_a_all) # add summary row
```

```{r}
# df_conv_a_adjust <- df_conv_a %>% 
#   group_by(a3_correction) %>% 
#   summarize(journal = "All", count = n())
# 
# df_conv_a %>% 
#   group_by(journal, a3_correction) %>% 
#   summarize(count = n(), .groups="drop") %>% 
#   add_row(df_conv_a_adjust) 
```


### Convention B: post-hoc
```{r}
# df_conv_b <- df_conv %>% 
#   filter(max_No_levels>2) %>% 
#   select(`Paper ID`, max_No_levels, starts_with("b"), journal)
# 
# # percentage of (not) performing post-hoc analysis when the main effect is (not) significant
# df_conv_b_artile <- df_conv_b %>% 
#   mutate(isConB = b5_main_effect_sig == b7_posthoc) %>% 
#   group_by(`Paper ID`, journal) %>% 
#   summarize(meanB_art = mean(isConB), .groups="drop")
# 
# # show the result
# df_conv_b_all <- df_conv_b_artile %>% 
#   summarize(journal = "All", conB = mean(meanB_art))
# 
# df_conv_b_artile %>% 
#   group_by(journal) %>% 
#   summarize(conB = mean(meanB_art)) %>% 
#   add_row(df_conv_b_all) # add summary row
```

Multiple comparison corrections (per ANOVA)
```{r}
# df_conv_b_adjust <- df_conv_b %>% 
#   filter(b5_main_effect_sig == 1) %>% 
#   group_by(b8_correction) %>% 
#   summarize(journal = 'All', count = n())
#   
# df_conv_b %>% 
#   filter(b5_main_effect_sig == 1) %>% 
#   group_by(journal, b8_correction) %>% 
#   summarize(count = n(), .groups="drop") %>% 
#   add_row(df_conv_b_adjust) 
```


### Convention C: simple effect analysis
```{r}
# df_conv_c <- df_conv %>% 
#   filter(N_factor>1) %>% 
#   select(`Paper ID`, N_factor, starts_with("c") & !starts_with("Con"), journal)
# 
# # percentage of (not) performing simple analysis when the interaction is (not) significant
# df_conv_c_artile <- df_conv_c %>% 
#   mutate(isConC = c5_inter_sig == c7_simple_effect) %>% 
#   group_by(`Paper ID`, journal) %>% 
#   summarize(meanC_art = mean(isConC), .groups="drop")
# 
# # show the result
# df_conv_c_all <- df_conv_c_artile %>% 
#   summarize(journal = "All", conC = mean(meanC_art))
# 
# df_conv_c_artile %>% 
#   group_by(journal) %>% 
#   summarize(conC = mean(meanC_art)) %>% 
#   add_row(df_conv_c_all) # add summary row
```

Multiple comparison corrections (per ANOVA)
```{r}
# df_conv_c_adjust <- df_conv_c %>% 
#   filter(c5_inter_sig == 1) %>% 
#   group_by(c8_correction) %>% 
#   summarize(journal = 'All', count = n())
#   
# df_conv_c %>% 
#   filter(c5_inter_sig == 1) %>% 
#   group_by(journal, c8_correction) %>% 
#   summarize(count = n(), .groups="drop") %>% 
#   add_row(df_conv_c_adjust)
```

### Convention D: separate 

```{r}
# df_conv_de <- df_conv %>% 
#   filter(N_factor>2) %>% 
#   select(`Paper ID`, N_factor, d1_e1_highest_sig, d1_separate, e1_combine, journal)
# 
# # 
# df_conv_d_artile <- df_conv_de %>% 
#   filter(d1_e1_highest_sig == 1) %>% 
#   group_by(`Paper ID`, journal) %>% 
#   summarize(meanD_art = mean(d1_separate), .groups="drop")
# 
# # show the result
# df_conv_d_all <- df_conv_d_artile %>% 
#   summarize(journal = "All", conD = mean(meanD_art))
# 
# df_conv_d_artile %>% 
#   group_by(journal) %>% 
#   summarize(conD = mean(meanD_art)) %>% 
#   add_row(df_conv_d_all) # add summary row
```

### Convention E: combine 

```{r}
# # 
# df_conv_e_artile <- df_conv_de %>% 
#   filter(d1_e1_highest_sig == 0) %>% 
#   group_by(`Paper ID`, journal) %>% 
#   summarize(meanE_art = mean(e1_combine), .groups="drop")
# 
# # show the result
# df_conv_e_all <- df_conv_e_artile %>% 
#   summarize(journal = "All", conE = mean(meanE_art))
# 
# df_conv_e_artile %>% 
#   group_by(journal) %>% 
#   summarize(conE = mean(meanE_art)) %>% 
#   add_row(df_conv_e_all) # add summary row
```


# Session information {.unnumbered}
```{r}
sessionInfo()
```




