---
title             : ''
shorttitle         : ""

author: 
  - name: "Haiyang Jin"
    affiliation: ""
    address: ""
    email: "haiyang.jin@outlook.com"
    corresponding: yes
    
affiliation:
  - id            : ""
    institution   : ""
  
authornote        : 
keywords          : "analysis of variances; practical applications; confirmatory data analysis; hypothesis-based Type I error rate; simple interaction analysis"
wordcount         : "X"

figurelist        : false
tablelist         : false
footnotelist      : false
linenumbers       : false
mask              : false
draft             : false
floatsintext      : true

documentclass     : "apa6"
classoption       : "man"
numbersections    : false
link-citations    : true

output:
    # papaja::apa6_word:
    #     toc: no
    papaja::apa6_pdf:
        toc: no
        toc_depth: 3
        highlight: default
        latex_engine: xelatex
        
date: "`r format(Sys.time(), '%d-%m-%Y')`"

header-includes   :
- \usepackage{booktabs}
- \usepackage{amsmath}
- \usepackage[american]{babel}
- \usepackage[utf8]{inputenc}
# - \usepackage[T1]{fontenc}
- \usepackage{sectsty} \allsectionsfont{\raggedright} # left-align H1 titles
bibliography: ["`r rbbt::bbt_write_bib('references/references.bib', overwrite = TRUE)`", "references/r-references.bib"]
---

```{r setup, include=FALSE}
## load libraries
library(knitr)
library(tidyverse)
library(afex)
library(emmeans)
library(lme4)
library(papaja)

options(emmeans=list(msg.interaction=FALSE))
theme_set(theme_apa())

# set global chunk options, put figures into folder
options(tinytex.verbose = TRUE)
options(warn=-1, replace.assign=TRUE)
knitr::opts_chunk$set(
  echo = FALSE,
  include = TRUE,
  # warning = FALSE,
  fig.align = "center",
  fig.path = "figures/figure-",
  fig.show = "hold",
  fig.width=7, fig.asp =0.618,
  width = 1800, 
  message = FALSE
)

source(here::here("R", "funcs.R"))
set.seed(2022)
```

\appendix

# Simulating Type I error in ANOVA

```{r}
Nsim <- 10000 # number of simulation
alphas <- c(0.001, 0.005, 0.01, 0.05, (1:4)/10)  # 0.001 ~ 0.4

```

## ANOVA omnibus F-test

```{r}
p_omni <- sim_omnibus(N_subj = 30, iter = Nsim, n_core=16, 
                      file_cache = here::here("simulation", "p_omni.rds"),
                      N_IV = 2:5)
```


```{r}
dfs_sig_omni <- sig_omnibus(p_omni, 0.05) 

dfs_sig_omni %>% 
  select(-c(N_sig, p.value)) %>% 
  group_by(N_IV, effnames) %>% 
  summarize(TypeI = mean(sig), .groups = "drop") %>% 
  pivot_wider(names_from = effnames, values_from = TypeI)
```

```{r}
dfs_sig_omni %>% 
  select(-c(N_sig, p.value)) %>% 
  group_by(N_IV, effnames) %>% 
  summarize(TypeI_with_omni = mean(sig_with_omni), .groups = "drop") %>% 
  pivot_wider(names_from = effnames, values_from = TypeI_with_omni)
```


## Main effect and post-hoc analysis
One-way ANOVA with three levels

```{r message=F}
# sim_main_posthoc is available in R/funcs.R
p_main_posthoc <- sim_main_posthoc(N_subj = 30, iter = Nsim, n_core=16, 
                                   file_cache = here::here("simulation", "p_main_posthoc.rds"),
                                   N_con = 4) 
```

```{r}
df_TypeI_posthoc <- sig_main_posthoc(p_main_posthoc, 0.05) %>% 
  mutate(sig_anypost = N_sigpost > 0, # any of the pairwise comparison is significant
         sig_both_main_post = sig_main * sig_anypost) %>% # both the main and any of pairwise are significant
  group_by(alpha, adjust) %>% 
  summarize(TypeI_both = mean(sig_both_main_post), 
            TypeI_postonly = mean(sig_anypost),
            .groups = "drop")

df_TypeI_posthoc
```


Claim significant results only when both the main effect and at least one of the post-hoc tests (with different multiple comparison corrections) are significant:
```{r}
df_TypeI_posthoc %>% 
  filter(adjust != "none") %>% # only when using multiple comparison correction
  select(-TypeI_postonly)
```

Claim significant results only when the main effect and at least one of the post-hoc tests (without different multiple comparison corrections) are significant:
```{r}
df_TypeI_posthoc %>% 
  filter(adjust == "none") # only when NOT using multiple comparison correction
```

Claim significant results only when at least one of the post-hoc tests (with different multiple comparison corrections) are significant (regardless of the main effect results): 
```{r}
df_TypeI_posthoc %>% 
  filter(adjust != "none") %>% # only when using multiple comparison correction
  select(-TypeI_both)
```


## Interaction and simple effect analysis

```{r}
p_inter_simple <- sim_inter_simple(N_subj = 30, iter = Nsim, n_core=16, 
                                   file_cache = here::here("simulation", "p_inter_simple.rds"))
```

```{r}

p_inter_simple %>% 
  group_by(adjust) %>% 
  summarize(mean(p_mainA<0.05), mean(p_mainB<0.05), mean(p_inter<0.05))

```

When both the interaction and at least one of the (four) simple effects were significant:
```{r}
sig_inter_simple(p_inter_simple, 0.05) %>% 
  mutate(sig_anysimple4 = N_sigsimple4 > 0,
         sig_anysimple2byA = N_sigsimple2byA > 0,
         sig_anysimple2byB = N_sigsimple2byB > 0,
         sig_both_inter_simple4 = sig_inter * sig_anysimple4,
         sig_both_inter_simple2byA = sig_inter * sig_anysimple2byA,
         sig_both_inter_simple2byB = sig_inter * sig_anysimple2byB) %>% 
  group_by(alpha, adjust) %>% 
  summarize(TypeI_both = mean(sig_both_inter_simple4), 
            TypeI_simpleonly = mean(sig_anysimple4),
            TypeI_bothbyA = mean(sig_both_inter_simple2byA),
            TypeI_bothbyB = mean(sig_both_inter_simple2byB),
            TypeI_simpleonlybyA = mean(sig_anysimple2byA),
            TypeI_simpleonlybyB = mean(sig_anysimple2byB),
            .groups = "drop")
```















#