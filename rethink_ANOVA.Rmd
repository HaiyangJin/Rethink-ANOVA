---
title             : "Appendices for rethink ANOVA"
shorttitle         : "Appendices for Rethink ANOVA"

author: 
  - name: "Haiyang Jin"
    affiliation: "1"
    address: "New York University Abu Dhabi, Saadiyat Isalnd, Abu Dhabi, United Arab Emirates"
    email: "haiyang.jin@nyu.edu"
    corresponding: yes
  - name: "Yuzhu Ji"
    affiliation : "2"
    email: "haiyang.jin@nyu.edu"
  - name: "William G. Hayward"
    affiliation : "3"
    email: "whayward@hku.hk"
    
affiliation:
  - id            : "1"
    institution   : "New York University Abu Dhabi"
  - id            : "2"
    institution   : "Zhejiang University of Technology"
  - id            : "3"
    institution   : "University of Hong Kong"
  
authornote        : |
  This is the appendices for the rethinking ANOVA paper.
bibliography      : ["r-references.bib"]

figsintext        : no
figurelist        : no
tablelist         : no
footnotelist      : no
linenumbers       : no
mask              : no
draft             : no
floatsintext      : yes

documentclass     : "apa6"
classoption       : "man"
numbersections    : yes
link-citations    : yes

output:
    # papaja::apa6_word:
    #     toc: no
    papaja::apa6_pdf:
        toc: no
        toc_depth: 3
        highlight: default
        number_sections: true
        latex_engine: xelatex
        
date: "`r format(Sys.time(), '%d-%m-%Y')`"

header-includes   :
- \usepackage{booktabs}
# - \usepackage{amsmath}  
# - \usepackage[american]{babel}
# - \usepackage[utf8]{inputenc}
# - \usepackage[T1]{fontenc}
# - \usepackage[backend=biber,useprefix=true,style=apa,url=false,doi=false,sorting=nyt,eprint=false]{biblatex}
# - \DeclareLanguageMapping{american}{american-apa}
# - \usepackage{fancyvrb}
# - \usepackage{newfloat}
# - \usepackage{graphicx}
# - \usepackage{caption}
# - \usepackage{listings}
# - \usepackage{placeins}
# - \usepackage{graphicx,pdflscape}
# - \usepackage{geometry}
# - \usepackage{float}
# - \usepackage{sectsty} \allsectionsfont{\raggedright} # left-align H1 titles
---

```{r setup and load the related libraries, include=FALSE}
## load libraries
library(knitr)
library(tidyverse)
library(afex)
library(emmeans)
library(lme4)
library(lmerTest)
library(ggpubr)
library(here)
library(papaja)

theme_set(theme_apa())

# set global chunk options, put figures into folder
options(warn=-1, replace.assign=TRUE)
knitr::opts_chunk$set(
	echo = FALSE,
	include = TRUE,
	# warning = FALSE,
	fig.align = "center",
	fig.path = "figures/figure-",
	fig.show = "hold",
	fig.width=7, fig.asp =0.618,
	width = 1800, 
	message = FALSE
)

n_cores <- parallel::detectCores()
set.seed(2021)
```

# Appendix 1: simulation
Training example?

a 3 (Group: control, protocal1, vs. protocal2) Ã— 2 (Test: pre-test vs. post-test) mixed ANOVA 


# Appendix 2: complete composite face paradigm
One of the popular paradigms measuring holistic face processing is the complete design composite face task [@Richler2014]. In this task, participants view two consecutive composite faces (made by combining top and bottom facial halves from different identities) and judge whether the two top halves are the same while ignore the bottom halves. There are mainly three independent variables in this paradigm: Congruency (*congruent* vs. *incongruent*), Alignment (*aligned* vs. *misaligned*), and SameDifferent (*same* vs. *different*). SameDifferent (*same* vs. *different*) refers to whether the two top (i.e., target) halves are the same or not (Figure \@ref(fig:ccf-design)). Alignment (*aligned* vs. *misaligned*) refers to whether the top and bottom facial halves are aligned or misaligned. Congruency (*congruent* vs. *incongruent*) refers to whether the situations of two top facial halves are the same as those of two bottom halves (Figure \@ref(fig:ccf-design)). Specifically, in *congruent* trials, when the two top halves are the same, the two bottom halves are also the same; when the two top halves are different, the bottom halves are different as well. Since in the *congreunt* trials, the situations are the same for both the top and bottom halves, the bottom halves should facilitate the processing of top halves if participants could not ignore the bottom halves. On the other hand, in *incongruent* trials, when the two top facial halves are different, the bottom halves are the same or vice versa. Thus, the bottom halves should interfere with the processing of top halves if participants could not ignore the bottom halves. In other words, participants are expected to perform better in the *congruent* relative to *incongruent* trials, which is also known as the Congruency effect. Critically, this effect should be reduced for misaligned composite faces if the influence of bottom halves on the top halves only take effects for aligned (intact) faces. This expected result pattern, also known as the composite face effect (CFE), is displayed in Figure \@ref(fig:ccf-result). If this result pattern is obtained in the composite task, we should find a significant interaction between Congruency and Alignment if we perform a 2 (Congruency: *congruent* vs. *incongruent*) $\times$ 2 (Alignment: *aligned* vs. *misaligned*) repeated-mesaures ANOVA. Probably this is why this interaction is typically employed as the index of CFE [e.g., @Ross2015; @Zhao2014]. However, a significant interaction between Congruency and Alignment does not gurantee the result pattern of CFE (Figure \@ref(fig:ccf-result)). For instance, a stronger Congruency effect for misaligned relative to aligned composites, which definitely does not reflect CFE, would also lead to a significant interaction. Therefore, the solely significant interaction is not sufficient to index CFE. We proposed to perform simple effect analysis in addition to the significant interaction to check whether the Congruency effect was only observed in the aligned, but not misaligned, condition [e.g., @Jin]. Although we could not obtain the support for the null effects in the misaligned condition with the conventional null hypothesis significance testing [@Cohen1994a], a non-significant result, with the significant interaction and Congruency effect in the aligned condition, suffices for claiming CFE.

(ref:ccf-design-caption) Experimental designs of the complete composite paradigm for aligned faces only. *Same* and *different* refers to whether the top facial (i.e., target) halves are the same. Congruency (*congruent* vs. *incongruent*) refers to whether the situations of two top facial halves are the same as those of two bottom halves. In *congruent* trials, when the two top halves are the same, the two bottom halves are also the same; when the two top halves are different, the bottom halves are different as well. In *incongruent* trials, when the two top halves are different, the bottom halves are the same, or vice versa.

```{r ccf-design, fig.width=5, fig.cap="(ref:ccf-design-caption)"}
knitr::include_graphics("images/ccf_design.png")
```

(ref:ccf-result-caption) Expected (simulated) results of the complete composite face paradigm, i.e., the composite effect. The *same* and *different* trials are treated as "signal" and "noise" in the signal detection theory, and both of them are used to calculate sensitivity *d*' to describe the behavioural responses. 

```{r ccf-result, fig.cap="(ref:ccf-result-caption)"}
tibble(Alignment = rep(c("aligned", "misaligned"), each=2),
       Congruency = rep(c("congruent", "incongruent"), 2),
       d = c(3.5, 2, 3, 2.9)) %>% 
  ggplot(aes(Alignment, d, color=Congruency, group=Congruency)) +
  geom_point(size=3, position=position_dodge(.1)) +
  geom_line(aes(linetype=Congruency), size=1) +
  ylim(c(0, 4)) +
  labs(y="Sensitivity"~italic(d)~"'") +
  theme(text = element_text(size = 18))
```

Next, we borrowed a data set from our previous paper [@Jin] and examine whether there is evidence for CFE with repeated-measures ANOVA, one-sample t-test, and linear mixed-effects models. 

## Repeated-measures ANOVA
In repeated-measures ANOVA, it is necesary to test (1) the two simple effects, and (2) the interaction. Noteworthy, we decided to test some of the simple effects according to the hypothesis and it is before we see the interaction result. The estimated marginal means are dispalyed in Figure \@ref(fig:aov-emm)

```{r}
df_cf_wide <- read_csv(here("data", "Jin_E1_d_wide.csv"))
df_cf_long <- df_cf_wide %>% 
  pivot_longer(contains("."),names_to=c("Congruency", "Alignment"), 
               names_sep="[.]", values_to="d")
```

```{r echo=T}
cf_aov <- aov_4(d ~ Congruency * Alignment + 
                   (Congruency * Alignment | Participant),
                data = df_cf_long)
cf_aov
```

```{r echo=T}
emm_aov <- emmeans(cf_aov, ~ Congruency | Alignment)
contrast(emm_aov, "pairwise")
```

(ref:aov-emm-caption) This is the results of ANOVA.

```{r aov-emm, fig.cap="(ref:aov-emm-caption)"}
ggplot(as_tibble(emm_aov), aes(Alignment, emmean, 
                               color=Congruency, group=Congruency)) +
  geom_point(size=3, position=position_dodge(.1)) +
  geom_line(aes(linetype=Congruency), size=1) +
  geom_errorbar(aes(ymin=lower.CL, ymax=upper.CL), width=.15, position=position_dodge(.1)) +
  ylim(c(0, 4)) +
  labs(y="Sensitivity"~italic(d)~"'") +
  theme(text = element_text(size = 18))
```


## One-sample t-test

As we discussed earlier, CFE mainly refers to (1) the performance for congruent trials are better than incongruent trials in the aligned condition, i.e., observing the Cognruency effect, and (2) the Congruency effect is stronger in the aligned relative to misaligned condition. Notably, we could test the Congruency effect in the aligned condition with the pairwise comparison between congruent_aligned and incongruent_aligned trials. In addition, 

Alternatively, calculate the differences of differences (i.e., $(d'_{congruent/aligned} - d'_{incongruent/aligned}) - (d'_{congruent/misaligned} - d'_{incongruent/misaligned})$) and test it aginst 0 [e.g., @Chua2014a; @Wang2019]. 

```{r, echo=T}
df_cf_d <- df_cf_wide %>% 
  mutate(d_cf = (congruent.aligned-incongruent.aligned)-
           (congruent.misaligned-incongruent.misaligned)) %>% 
  select(Participant, d_cf)

t.test(df_cf_d$d_cf)
```

```{r}
t.test(df_cf_d$d_cf, alternative="greater")
```

## Linear mixed-effects models

```{r, echo=T}
cf_lmm <- lmer(d ~ Congruency * Alignment + 
                   (Congruency + Alignment | Participant),
                data = df_cf_long)
summary(cf_lmm)
```

```{r}
emm_lmm <- emmeans(cf_lmm, ~ Congruency | Alignment)
contrast(emm_lmm, "pairwise")
```


priori contrasts


# Reference {.unnumbered}
```{r create_r-references, echo=F, cache = FALSE}
papaja::r_refs(file = "r-references.bib")
```

